---
title: "Cristiano_Replicate"
author: "Akshaya Annapragada"
date: "2024-01-26"
output: html_document
---

Read in Libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("plyr")
library("dplyr")
library("tidyverse")
library("ggplot2")
library("readxl")
library("devtools")
library("here")
library("caret")
library("recipes")
library("pROC")
```

Import all data and format metadata
```{r data_read}
aa_data <- "data/data_akshaya"
delfi<- read_csv(here(aa_data,"Cristiano-training-set-full.csv")) 

meth<-readRDS(here(aa_data,"output_ML.rds"))
#meth_old<-readRDS("../Cristiano/output_ML.rds")
#meth<-meth %>% dplyr::select(sample,class,class_group,contains("regular"))
meth<-meth %>% filter(sample %in% delfi$id) #Need to get rid of some LUCAS and D/C healthies that are in here
meth<-meth %>% filter(class_group=="CGPLH"|class_group=="CGPLPA")
meth<-meth %>% dplyr::select(-class) %>% dplyr::rename("type"="class_group")
meth<-meth %>% mutate(type=if_else(type=="CGPLH","healthy","cancer"))

data<-inner_join(delfi %>% dplyr::select(-type,-Tumor_Type),meth,by=c("id"="sample"))

#delfi<-inner_join(delfi %>% select(-type,-Tumor_Type),meth %>% select(sample,type),by=c("id"="sample"))
delfi<-delfi %>% dplyr::select(-Tumor_Type)

```

#Now work on the ensembles!
#10 fold -- leave the test set out each time, you have to manually run it for each of 10 times (the 5 cells below)
#fold01 - 09, fold10
```{r}
library(splitTools)
set.seed(1234)
train_folds<-create_folds(meth$type,k=10)

train_IDs<-meth$sample[train_folds$Fold10]
test_IDs<-meth$sample[-train_folds$Fold10]
name<-"output/fold10_ens.csv"
```

#train meth GBM 5x1 on train set and save CV
#train DELFI LR 5x1 on train set and save CV
#Of note, we are spiking in the Cristiano cancers of other types as extra training data
#use CV preds to train ensemble

#predict DELFI and Meth on test set
#predict ensemble on test set

```{r}
set.seed(1234)
meth_data_train<-meth %>% filter(sample %in% train_IDs)
meth_data_test<-meth %>% filter(sample %in% test_IDs)

recipe_meth <- recipe(type ~ ., data=meth_data_train) %>%
    update_role(sample, new_role = "ID") %>%
    step_corr(all_predictors(), threshold=0.95) %>%
    step_nzv(all_predictors())
set.seed(1234)
ctrl_meth <- trainControl(method = "repeatedcv",
                     number = 5,
                     repeats = 1,
                     verboseIter = TRUE,
                     savePredictions="final",
                     classProbs=TRUE,
                     index=createMultiFolds(meth_data_train$type, 5, 1),
                     summaryFunction = twoClassSummary)

set.seed(1234)
model_meth <- caret::train(recipe_meth,
                      data = meth_data_train,
                      method = "gbm",
                      trControl = ctrl_meth)
#############
delfi_data_train<-delfi %>% filter(!id %in% test_IDs)
delfi_data_test<-delfi %>% filter(id %in% test_IDs)

recipe_delfi <- recipe(type ~ ., data=delfi_data_train) %>%
    update_role(id, new_role = "ID") %>%
    step_rm(starts_with("ratio"),starts_with("short")) %>%
    step_pca(starts_with("cov"), prefix = "cov_pc_",  threshold=0.90)     %>%
    step_corr(all_predictors(), threshold=0.95) %>%
    step_nzv(all_predictors())


glmnetGrid <- expand.grid(
    alpha = 1,
    lambda = 10^seq(-5, -1, length.out = 100))
#### Train models
set.seed(1234)
ctrl_delfi <- trainControl(method = "repeatedcv",
                     number = 5,
                     repeats = 1,
                     verboseIter = TRUE,
                     savePredictions="final",
                     classProbs=TRUE,
                     index=createMultiFolds(delfi_data_train$type, 5, 1),
                     summaryFunction = twoClassSummary)

set.seed(1234)
model_delfi <- caret::train(recipe_delfi,
                          data = delfi_data_train,
                          method = "glmnet",
                          tuneGrid = glmnetGrid,
                          trControl = ctrl_delfi)
##########
pred.all <- model_meth$pred
pred.all <- pred.all %>% dplyr::group_by(rowIndex) %>% dplyr::summarize(score.meth = mean(cancer))
all_data <- meth_data_train %>% dplyr::mutate(rowIndex = 1:n())
labels <- all_data %>% dplyr::select(type,sample,rowIndex)
preds_all <- dplyr::inner_join(labels, pred.all, by="rowIndex")

pred.all <- model_delfi$pred
pred.all <- pred.all %>% dplyr::group_by(rowIndex) %>% dplyr::summarize(score.delfi = mean(cancer))
all_data <- delfi_data_train %>% dplyr::mutate(rowIndex = 1:n())
labels <- all_data %>% dplyr::select(id,rowIndex)
preds <- dplyr::inner_join(labels, pred.all, by="rowIndex")

preds_CV<-inner_join(preds_all,preds,by=c("sample"="id"))



recipe_ens <- recipe(type ~ score.meth + score.delfi, data=preds_CV)

set.seed(1234)
ctrl_ens <- trainControl(method = "repeatedcv",
                     number = 5,
                     repeats = 1,
                     verboseIter = TRUE,
                     savePredictions="final",
                     classProbs=TRUE,
                     index=createMultiFolds(preds_CV$type, 5, 1),
                     summaryFunction = twoClassSummary)




set.seed(1234)
model_ens <- caret::train(recipe_ens,
                          data = preds_CV,
                          method = "glmnet",
                          tuneGrid = glmnetGrid,
                          trControl = ctrl_ens)
#######
#Delfi Preds
delfi_preds<-predict(model_delfi,delfi_data_test,type="prob")$cancer
meth_preds<-predict(model_meth,meth_data_test,type="prob")$cancer

preds<-cbind(meth_data_test %>% dplyr::select(sample,type),meth_preds)
preds2<-cbind(delfi_data_test %>% dplyr::select(id),delfi_preds)
preds<-inner_join(preds,preds2,by=c("sample"="id"))
preds<-preds %>% dplyr::rename(score.delfi=delfi_preds) %>% dplyr::rename(score.meth=meth_preds)
ens_preds<-predict(model_ens,preds,type="prob")$cancer

preds<-cbind(preds,ens_preds)

write.csv(preds,here(name))

```



After you have generated all 10 folds above!!!!
Read all the results
```{r}
data <- list.files(path=here("output"),pattern="fold*", full.names = TRUE) %>% 
  lapply(read_csv) %>% 
  bind_rows 

write.csv(data,here("output/All_Scores.csv"))

delfi_roc<-pROC::roc(data$type,data$score.delfi,ci=TRUE,levels=c("healthy","cancer"))
meth_roc<-pROC::roc(data$type,data$score.meth,ci=TRUE,levels=c("healthy","cancer"))
ens_roc<-pROC::roc(data$type,data$ens_preds,ci=TRUE,levels=c("healthy","cancer"))


delfi_type<-paste0("DELFI: ",round(delfi_roc$auc[1],2)," (",round(delfi_roc$ci[1],2),"-",round(delfi_roc$ci[3],2),")")
meth_type<-paste0("Methylation: ",round(meth_roc$auc[1],2)," (",round(meth_roc$ci[1],2),"-",round(meth_roc$ci[3],2),")")
ens_type<-paste0("Ensemble: ",round(ens_roc$auc[1],2)," (",round(ens_roc$ci[1],2),"-",round(ens_roc$ci[3],2),")")


res<-tibble(type=delfi_type,sens=delfi_roc$sensitivities,spec=delfi_roc$specificities)
res1<-tibble(type=meth_type,sens=meth_roc$sensitivities,spec=meth_roc$specificities)
res2<-tibble(type=ens_type,sens=ens_roc$sensitivities,spec=ens_roc$specificities)

res<-rbind(res,res1,res2)
res$type<-factor(res$type,levels=c(meth_type,delfi_type,ens_type))

#levels(res$type)=c(meth_type,delfi_type,ens_type)
```

```{r}
library(RColorBrewer)

colors <- brewer.pal(3, "Dark2")

roc_colors <- colors[1:3] #%>%
    #setNames(ens_type,delfi_type,meth_type) #levels(res$type)

B <- res %>%
    arrange(sens) %>%
    ggplot(aes(spec, sens, group=type,color=type)) +
    geom_vline(xintercept=0.80,
               color="gray80", size=0.5, linetype="dashed") +
    geom_line(aes(color=type), size=1.1) +
    scale_x_reverse(expand=c(0, 0.01),
                    breaks=c(0, 0.25, 0.5, 0.80, 1),
                    labels=as.character(
                        c("0", ".25", ".50", ".80", "1.0"))) +
    scale_y_continuous(expand=c(0, 0.01),
                       breaks=c(0, 0.25, 0.5, 0.75, 1),
                       labels=as.character(
                           c("0", ".25", ".50", ".75", "1.0"))) +
    scale_color_manual(values=roc_colors) +
    theme_classic(base_size=20) +
    theme(panel.grid=element_blank(),
          legend.position=c(0.6, 0.2),
          aspect.ratio=0.8,
          legend.text.align=1,
          legend.title=element_text(size=16)) +
    xlab("Specificity") + ylab("Sensitivity") +
    guides(color=guide_legend(title="AUC: (95% CI)", hjust=1))+ggtitle("Cristiano Data")
B


pdf(here("docs/figure/Fig_4C.pdf"))
B
dev.off()
```

```{r}
healthies<- meth %>% filter(!sample %in% delfi$id) %>% select(type,sample)

write.csv(healthies,here("output/needtodrop.csv"))
```






